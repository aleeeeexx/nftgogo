{"version":3,"sources":["webpack:///./src/pages/mobile-login.vue?3ba5","webpack:///./src/utils/pulin-login.ts","webpack:///./src/pages/mobile-login.vue","webpack:///./src/pages/mobile-login.vue?a4d3"],"names":["getUserInfo","accessToken","companyCode","res","reflesh","data","setStorage","userInfo","externalUserId","mobile","userId","refreshToken","localStorage","setItem","useLogin","path","router","getItem","localRefreshToken","fleshUserInfo","Object","assign","replace","query","redirect","encodeURIComponent","console","log","_hoisted_1","class","_hoisted_2","_hoisted_3","_hoisted_4","_hoisted_5","setup","__props","route","phone","code","codeSent","seconds","sendCode","value","message","countDown","timer","setInterval","clearInterval","login","verifyCode","decodeURIComponent","_ctx","_cache","_component_van_field","modelValue","$event","modelModifiers","trim","label","type","placeholder","maxlength","active","onClick","length","__scopeId"],"mappings":"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","file":"js/mobileLogin.e1ea8475.js","sourcesContent":["export * from \"-!../../node_modules/mini-css-extract-plugin/dist/loader.js??ref--8-oneOf-1-0!../../node_modules/css-loader/dist/cjs.js??ref--8-oneOf-1-1!../../node_modules/vue-loader-v16/dist/stylePostLoader.js!../../node_modules/postcss-loader/src/index.js??ref--8-oneOf-1-2!../../node_modules/sass-loader/dist/cjs.js??ref--8-oneOf-1-3!../../node_modules/cache-loader/dist/cjs.js??ref--0-0!../../node_modules/vue-loader-v16/dist/index.js??ref--0-1!./mobile-login.vue?vue&type=style&index=0&id=0c394c8a&lang=scss&scoped=true\"","import { getUserInfoByToken, refreshToken } from '@/api/user'\nimport { useRouter } from 'vue-router'\n\n// 根据朴邻token查询用户信息\nconst getUserInfo = async (accessToken: string, companyCode: string) => {\n  const res = await getUserInfoByToken(accessToken, companyCode)\n  return res\n}\n\n// 刷新token\nconst reflesh = async (data: object) => {\n  const res = await refreshToken(data)\n  return res\n}\n\ninterface TokenUserInfo {\n  externalUserId: string\n  mobile: string\n  userId: string\n  accessToken: string\n  refreshToken: string\n}\n\n// 设置storage\nexport const setStorage = (userInfo: TokenUserInfo) => {\n  const { externalUserId, mobile, userId, accessToken, refreshToken } = userInfo\n  externalUserId && localStorage.setItem('externalUserId', externalUserId)\n  mobile && localStorage.setItem('mobile', mobile)\n  userId && localStorage.setItem('userId', userId)\n  accessToken && localStorage.setItem('access_token', accessToken)\n  refreshToken && localStorage.setItem('refreshToken', refreshToken)\n}\n\n// 朴邻跳转登录逻辑\nexport const useLogin = async (accessToken: string, companyCode: string, path: string) => {\n  if (!accessToken || !companyCode) return false\n  const router = useRouter()\n  const userInfo = await getUserInfo(accessToken, companyCode)\n  setStorage(userInfo)\n  // 保存朴邻的token和companyCode\n  localStorage.setItem('companyCode', companyCode)\n  localStorage.setItem('pulin_token', accessToken)\n  // // 本地保存的数据 --- 可用于刷新token\n  const mobile = localStorage.getItem('mobile') as string\n  const userId = localStorage.getItem('userId') as string\n  const externalUserId = localStorage.getItem('externalUserId') as string\n  const localRefreshToken = localStorage.getItem('refreshToken') as string\n  // 校验手机号和本地一致并且刷新token所需数据存在，执行刷新token操作\n  if (userInfo.mobile === mobile && externalUserId && localRefreshToken && userId) {\n    try {\n      // 刷新token\n      const fleshUserInfo = await reflesh({\n        externalUserId,\n        userId,\n        refreshToken: localRefreshToken\n      })\n      setStorage(Object.assign(fleshUserInfo, { mobile }))\n    } catch (error) {\n      // 刷新token失败去登录\n      router.replace({\n        path: '/mobile-login',\n        query: {\n          mobile: userInfo.mobile,\n          redirect: encodeURIComponent(path)\n        }\n      })\n    }\n  } else {\n    // 否则去登录\n    console.log('useRouter(): ', router)\n    // 去手机验证码登录页\n    router.replace({\n      path: '/mobile-login',\n      query: {\n        mobile: userInfo.mobile,\n        redirect: encodeURIComponent(path)\n      }\n    })\n  }\n  return true\n}\n","import { defineComponent as _defineComponent } from 'vue'\nimport { createElementVNode as _createElementVNode, resolveComponent as _resolveComponent, createVNode as _createVNode, toDisplayString as _toDisplayString, normalizeClass as _normalizeClass, openBlock as _openBlock, createElementBlock as _createElementBlock, withScopeId as _withScopeId, pushScopeId as _pushScopeId, popScopeId as _popScopeId } from \"vue\"\n\n_pushScopeId(\"data-v-0c394c8a\")\nconst _hoisted_1 = { class: \"login\" }\nconst _hoisted_2 = /*#__PURE__*/_createElementVNode(\"div\", { class: \"title\" }, \"验证码登录\", -1)\nconst _hoisted_3 = { class: \"con\" }\nconst _hoisted_4 = { class: \"input-box\" }\nconst _hoisted_5 = { class: \"input-box code\" }\n_popScopeId()\n\nimport { onBeforeUnmount, ref } from 'vue'\nimport { useRoute, useRouter } from 'vue-router'\nimport { getVerifyCode, loginByVerifyCode } from '@/api/user'\nimport { setStorage } from '@/utils/pulin-login'\nimport { Toast } from 'vant'\n\nexport default _defineComponent({\n  setup(__props) {\n\nconst router = useRouter()\nconst route = useRoute()\n// 手机号\nconst phone = ref('18289755297')\n// 输入的验证码\nconst code = ref('123')\n// 获取验证码\n// 是否发送\nconst codeSent = ref(false)\n// 倒计时秒数\nconst seconds = ref(60)\n// 点击发送\nconst sendCode = async () => {\n  // 已发送不操作\n  if (codeSent.value) return\n  const res = await getVerifyCode(phone.value)\n  console.log(res)\n  code.value = res.message\n  Toast('验证码已发送')\n  codeSent.value = true\n  countDown()\n}\n// 倒计时\nlet timer: number = 0\nconst countDown = () => {\n  seconds.value = 60\n  timer = setInterval(() => {\n    if (seconds.value > 0) seconds.value--\n    else {\n      clearInterval(timer)\n      timer = 0\n      codeSent.value = false\n    }\n  }, 1000)\n}\n\n// 登录/注册\nconst login = async () => {\n  const userInfo = await loginByVerifyCode({\n    phone: phone.value,\n    verifyCode: code.value\n    // userId: localStorage.getItem('userId')\n    // externalUserId: localStorage.getItem('externalUserId')\n  })\n  console.log(userInfo)\n  if (userInfo.phone) {\n    setStorage(userInfo)\n    router.replace('/personal-center')\n  }\n  console.log(localStorage.getItem('access_token'), 'getItem')\n  console.log(decodeURIComponent(route.query.redirect as string))\n  // const path = decodeURIComponent(route.query.redirect as string)\n  // router.replace(path + (path.includes('?') ? '&' : '?') + 'isPulin=1')\n}\n// 页面卸载，清除定时器\nonBeforeUnmount(() => {\n  timer && clearInterval(timer)\n})\n\nreturn (_ctx: any,_cache: any) => {\n  const _component_van_field = _resolveComponent(\"van-field\")!\n\n  return (_openBlock(), _createElementBlock(\"div\", _hoisted_1, [\n    _hoisted_2,\n    _createElementVNode(\"div\", _hoisted_3, [\n      _createElementVNode(\"div\", _hoisted_4, [\n        _createVNode(_component_van_field, {\n          modelValue: phone.value,\n          \"onUpdate:modelValue\": _cache[0] || (_cache[0] = ($event: any) => (phone.value = $event)),\n          modelModifiers: { trim: true },\n          label: \"\",\n          type: \"tel\",\n          placeholder: \"请输入手机号\",\n          maxlength: 11\n        }, null, 8, [\"modelValue\"])\n      ]),\n      _createElementVNode(\"div\", _hoisted_5, [\n        _createVNode(_component_van_field, {\n          modelValue: code.value,\n          \"onUpdate:modelValue\": _cache[1] || (_cache[1] = ($event: any) => (code.value = $event)),\n          modelModifiers: { trim: true },\n          label: \"\",\n          type: \"tel\",\n          placeholder: \"请输入验证码\",\n          maxlength: 6\n        }, null, 8, [\"modelValue\"]),\n        _createElementVNode(\"div\", {\n          class: _normalizeClass([\"code-btn\", { active: !codeSent.value }]),\n          onClick: sendCode\n        }, _toDisplayString(codeSent.value ? seconds.value + 's后重新获取' : '获取验证码'), 3)\n      ]),\n      _createElementVNode(\"div\", {\n        class: _normalizeClass([\"btn-wrap\", { 'active-login': code.value.length > 3 }]),\n        onClick: login\n      }, \" 登录 \", 2)\n    ])\n  ]))\n}\n}\n\n})","import script from \"./mobile-login.vue?vue&type=script&lang=ts&setup=true\"\nexport * from \"./mobile-login.vue?vue&type=script&lang=ts&setup=true\"\n\nimport \"./mobile-login.vue?vue&type=style&index=0&id=0c394c8a&lang=scss&scoped=true\"\nscript.__scopeId = \"data-v-0c394c8a\"\n\nexport default script"],"sourceRoot":""}